<!-- START OF FILE text/html -->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <meta name="theme-color" content="#020406">
    <title>Neon Elite | VIP Gaming Terminal</title>
    
    <!-- Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/gsap/3.12.2/gsap.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.1/firebase-firestore-compat.js"></script>

    <style>
        :root {
            --bg: #020406;
            --card: rgba(10, 15, 25, 0.95);
            --glass: rgba(255, 255, 255, 0.05);
            --gold: #f59e0b;
            --gold-glow: rgba(245, 158, 11, 0.4);
            --emerald: #10b981;
            --ruby: #ef4444;
            --text: #f8fafc;
            --text-muted: #94a3b8;
            --border: rgba(255, 255, 255, 0.1);
            --neon-cyan: #00f3ff;
            --neon-pink: #ff003c;
        }

        [data-theme="light"] {
            --bg: #f1f5f9;
            --card: #ffffff;
            --glass: #e2e8f0;
            --text: #0f172a;
            --text-muted: #64748b;
            --border: #cbd5e1;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        
        body { 
            background: var(--bg); 
            color: var(--text); 
            overflow: hidden; 
            height: 100vh; 
            height: 100dvh; 
            width: 100vw; 
            transition: background 0.3s, color 0.3s; 
        }

        main { 
            flex: 1; 
            overflow-y: auto; 
            overflow-x: hidden;
            padding: 15px; 
            padding-bottom: 120px; 
            position: relative; 
            -webkit-overflow-scrolling: touch; 
        }
        main::-webkit-scrollbar { display: none; }

        #app-interface { height: 100%; display: flex; flex-direction: column; }

        /* --- Full Screen Game Mode --- */
        body.game-mode header, body.game-mode nav { display: none !important; }
        body.game-mode main { padding: 0 !important; height: 100%; overflow-y: hidden; }
        body.game-mode .game-view-container { 
            height: 100%; 
            width: 100%;
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            padding: 15px;
            background: var(--bg);
            position: relative;
        }

        /* --- Components --- */
        #toast-container { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); z-index: 5000; width: 90%; max-width: 350px; pointer-events: none; }
        .toast { background: var(--card); backdrop-filter: blur(15px); border: 1px solid var(--border); padding: 15px 20px; border-radius: 16px; display: flex; align-items: center; gap: 12px; margin-bottom: 10px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); opacity: 0; transform: translateY(-20px); font-size: 13px; color: var(--text); }
        .toast.success { border-left: 4px solid var(--emerald); }
        .toast.error { border-left: 4px solid var(--ruby); }

        #loading-screen, #banned-screen { position: fixed; inset: 0; background: var(--bg); z-index: 4000; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; padding: 30px; }
        #banned-screen { display: none; background: radial-gradient(circle, #300, #020406); }
        .logo-glow { width: 80px; height: 80px; filter: drop-shadow(0 0 15px var(--gold)); animation: pulse 2s infinite; }
        @keyframes pulse { 0%, 100% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.1); opacity: 0.6; } }

        #auth-screen { height: 100vh; display: none; flex-direction: column; overflow-y: auto; padding-top: 50px; }
        .modern-card { background: var(--card); backdrop-filter: blur(30px); border: 1px solid var(--border); border-radius: 30px; padding: 25px; width: 95%; max-width: 400px; margin: auto; box-shadow: 0 20px 40px rgba(0,0,0,0.1); transition: background 0.3s; margin-bottom: 20px; }

        .field { position: relative; margin-bottom: 12px; }
        .field i { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); color: var(--gold); width: 16px; }
        input, select { width: 100%; background: var(--glass); border: 1px solid var(--border); padding: 12px 12px 12px 45px; border-radius: 14px; color: var(--text); outline: none; font-size: 14px; }
        input:focus { border-color: var(--gold); box-shadow: 0 0 10px var(--gold-glow); }

        .checkbox-container { display: flex; align-items: flex-start; gap: 10px; margin-bottom: 15px; }
        .checkbox-container input { width: 20px; height: 20px; accent-color: var(--gold); background: transparent; padding: 0; margin-top: 2px; }
        .checkbox-container label { font-size: 11px; color: var(--text-muted); line-height: 1.4; }
        .checkbox-container a { color: var(--gold); text-decoration: none; font-weight: bold; }

        .btn { width: 100%; padding: 16px; border-radius: 16px; border: none; font-weight: 800; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 10px; text-transform: uppercase; font-size: 12px; letter-spacing: 1px; transition: 0.2s; }
        .btn-primary { background: linear-gradient(135deg, var(--emerald), #065f46); color: white; }
        .btn-gold { background: var(--gold); color: black; box-shadow: 0 0 15px var(--gold-glow); }
        .btn-crash { background: linear-gradient(135deg, var(--neon-pink), #990024); color: white; box-shadow: 0 0 15px rgba(255, 0, 60, 0.4); }
        .btn-outline { background: transparent; border: 1px solid var(--border); color: var(--text); }
        .btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(1); }

        header { padding: 15px 20px; display: flex; justify-content: space-between; align-items: center; background: var(--card); border-bottom: 1px solid var(--border); transition: background 0.3s; flex-shrink: 0; }
        .bal-pill { display: flex; align-items: center; gap: 8px; background: rgba(245,158,11,0.1); border: 1px solid var(--gold); padding: 8px 16px; border-radius: 50px; color: var(--gold); font-weight: 900; }
        
        nav { position: fixed; bottom: 0; width: 100%; height: 85px; background: var(--card); display: flex; justify-content: space-around; align-items: center; border-top: 1px solid var(--border); padding-bottom: 10px; z-index: 100; transition: background 0.3s; }
        .nav-item { color: var(--text-muted); display: flex; flex-direction: column; align-items: center; font-size: 10px; gap: 5px; cursor: pointer; transition: 0.3s; }
        .nav-item.active { color: var(--gold); transform: translateY(-3px); }

        .view { display: none; width: 100%; }
        .view.active { display: block; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

        /* --- CAROUSEL --- */
        .carousel-container { width: 100%; height: 200px; overflow: hidden; margin-bottom: 25px; border-radius: 20px; border: 1px solid var(--border); background: var(--card); position: relative; box-shadow: 0 10px 30px rgba(0,0,0,0.3); }
        .carousel-track { display: flex; transition: transform 0.6s cubic-bezier(0.25, 1, 0.5, 1); width: 100%; height: 100%; }
        .carousel-slide { min-width: 100%; height: 100%; position: relative; }
        .carousel-slide img { width: 100%; height: 100%; object-fit: cover; filter: brightness(0.7); }
        .carousel-content { position: absolute; bottom: 20px; left: 20px; z-index: 2; }
        .proof-badge { background: var(--gold); color: black; padding: 5px 12px; border-radius: 8px; font-size: 11px; font-weight: 900; display: inline-block; margin-bottom: 5px; box-shadow: 0 5px 15px rgba(245, 158, 11, 0.4); }
        .proof-text { color: #fff; font-size: 18px; font-weight: 800; text-shadow: 0 2px 10px rgba(0,0,0,0.9); }

        /* --- 2x Game Grid --- */
        .games-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; padding-bottom: 20px; }
        .g-card { background: var(--card); border: 1px solid var(--border); border-radius: 20px; overflow: hidden; position: relative; transition: transform 0.1s; cursor: pointer; box-shadow: 0 5px 20px rgba(0,0,0,0.2); }
        .g-card:active { transform: scale(0.97); }
        .g-icon { height: 110px; display: flex; align-items: center; justify-content: center; font-size: 50px; position: relative; }
        .g-info { padding: 12px; }
        .g-title { font-size: 14px; font-weight: 900; color: var(--text); margin-bottom: 8px; letter-spacing: 0.5px; }
        .g-footer { display: flex; justify-content: space-between; align-items: center; }
        .play-tag { background: var(--text); color: var(--bg); padding: 4px 12px; border-radius: 20px; font-size: 10px; font-weight: 900; display: flex; align-items: center; gap: 3px; }
        .live-users { font-size: 10px; color: var(--text-muted); display: flex; align-items: center; gap: 4px; font-weight: 600; }
        .live-dot { width: 6px; height: 6px; background: var(--emerald); border-radius: 50%; box-shadow: 0 0 5px var(--emerald); }

        /* --- Sidebar --- */
        .sidebar { position: fixed; top: 0; left: -260px; width: 260px; height: 100vh; background: var(--card); border-right: 1px solid var(--border); z-index: 6000; transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); padding: 25px; display: flex; flex-direction: column; gap: 20px; box-shadow: 5px 0 30px rgba(0,0,0,0.5); }
        .sidebar.open { left: 0; }
        .sidebar-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 5999; display: none; opacity: 0; transition: 0.3s; }
        .sidebar-overlay.active { display: block; opacity: 1; }

        /* --- In-Game Navigation Elements --- */
        .game-menu-btn { position: absolute; top: 20px; left: 20px; width: 45px; height: 45px; background: rgba(20, 20, 30, 0.8); backdrop-filter: blur(12px); border: 1px solid var(--border); border-radius: 14px; display: flex; align-items: center; justify-content: center; cursor: pointer; z-index: 500; transition: 0.3s; color: var(--text); box-shadow: 0 10px 20px rgba(0,0,0,0.3); }
        .game-menu-btn:hover { transform: scale(1.05); }
        .game-balance-pill { position: absolute; top: 20px; right: 20px; background: rgba(0, 0, 0, 0.7); backdrop-filter: blur(10px); border: 1px solid var(--gold); padding: 8px 16px; border-radius: 30px; color: var(--gold); font-weight: 900; font-size: 13px; z-index: 500; display: flex; align-items: center; gap: 6px; box-shadow: 0 5px 20px rgba(0,0,0,0.4); }

        /* --- Toggle Switch --- */
        .switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: var(--glass); border: 1px solid var(--border); transition: .4s; border-radius: 34px; }
        .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 3px; background-color: var(--text); transition: .4s; border-radius: 50%; }
        input:checked + .slider { background-color: var(--gold); }
        input:checked + .slider:before { transform: translateX(24px); background-color: #000; }

        /* --- MINES GRID --- */
        .mines-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin: 10px auto; width: 100%; max-width: 320px; aspect-ratio: 1/1; }
        .tile { width: 100%; height: 100%; background: var(--glass); border-radius: 8px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: center; font-size: 20px; cursor: pointer; transition: 0.2s; }
        
        /* --- TOWER GRID --- */
        .tower-wrap { width: 100%; max-width: 300px; height: 400px; margin: 0 auto; display: flex; flex-direction: column-reverse; gap: 6px; position: relative; }
        .t-row { flex: 1; display: grid; grid-template-columns: repeat(3, 1fr); gap: 6px; }
        .t-row.locked { opacity: 0.1; pointer-events: none; }
        .brick { background: var(--glass); border: 1px solid var(--border); border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 14px; }
        #ball { position: absolute; width: 12px; height: 12px; background: white; border-radius: 50%; bottom: -12px; left: 50%; transform: translateX(-50%); box-shadow: 0 0 10px #fff; z-index: 10; }

        /* --- PLINKO GAME UI (Mobile Fitted) --- */
        #plinko-container { 
            width: 100%; 
            height: 55vh; /* Fits mobile screen better */
            max-height: 500px;
            background: #0b0f19; 
            border-radius: 16px; 
            border: 1px solid var(--border); 
            position: relative; 
            overflow: hidden; 
            margin-bottom: 15px; 
        }
        #plinko-canvas { width: 100%; height: 100%; display: block; }
        
        /* --- PROFESSIONAL SPIN WHEEL UI --- */
        .wheel-container { position: relative; width: 320px; height: 320px; margin: 40px auto; }
        .wheel-outer { 
            width: 100%; height: 100%; 
            border-radius: 50%; 
            border: 5px solid var(--gold); /* Gold Rim */
            box-shadow: 0 0 30px var(--gold-glow), inset 0 0 20px rgba(0,0,0,0.8); 
            overflow: hidden; 
            position: relative; 
            transition: transform 4s cubic-bezier(0.1, 0.9, 0.2, 1); 
        }
        
        .wheel-center {
            position: absolute;
            top: 50%; left: 50%;
            transform: translate(-50%, -50%);
            width: 50px; height: 50px;
            background: radial-gradient(circle, #fff, var(--gold));
            border-radius: 50%;
            border: 4px solid #000;
            z-index: 5;
            box-shadow: 0 0 10px rgba(0,0,0,0.8);
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .wheel-center::after { content: "â˜…"; font-size: 20px; color: #000; }

        .wheel-pointer { 
            position: absolute; 
            top: -20px; left: 50%; 
            transform: translateX(-50%); 
            width: 0; height: 0; 
            border-left: 20px solid transparent; 
            border-right: 20px solid transparent; 
            border-top: 40px solid var(--neon-pink); 
            z-index: 10; 
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.8)); 
        }
        
        /* 8 Segments Conic Gradient (45deg each) */
        .wheel-bg {
            width: 100%; height: 100%;
            background: conic-gradient(
                #10b981 0deg 45deg,    /* +5 */
                #ef4444 45deg 90deg,   /* -5 */
                #10b981 90deg 135deg,  /* +3 */
                #ef4444 135deg 180deg, /* -3 */
                #10b981 180deg 225deg, /* +1 */
                #ef4444 225deg 270deg, /* -1 */
                #f59e0b 270deg 315deg, /* Free */
                #1e293b 315deg 360deg  /* Nothing */
            );
            border-radius: 50%;
        }
        
        .wheel-text { 
            position: absolute; 
            top: 0; left: 50%; 
            width: 2px; height: 50%; 
            transform-origin: bottom; 
            display: flex; 
            justify-content: center; 
            padding-top: 15px; 
            pointer-events: none;
        }
        .w-label { 
            color: white; 
            font-weight: 900; 
            font-size: 16px; 
            transform: translateX(-50%); 
            text-shadow: 0 2px 4px black; 
            writing-mode: vertical-rl; 
            text-orientation: mixed; 
        }

        /* --- CRASH UI --- */
        #crash-stage { position: relative; width: 100%; height: 280px; background: #050505; border-radius: 20px; border: 1px solid var(--border); overflow: hidden; margin-bottom: 15px; box-shadow: inset 0 0 50px rgba(0,0,0,0.8); }
        #crash-canvas { width: 100%; height: 100%; display: block; }
        
        /* New Location for Crash History (Below Bet Buttons) */
        .crash-history-container {
            width: 100%;
            margin-top: 5px;
            margin-bottom: 15px;
            padding: 5px;
            overflow-x: auto;
            white-space: nowrap;
            -webkit-overflow-scrolling: touch;
        }
        .crash-history-container::-webkit-scrollbar { display: none; }
        
        .h-badge { 
            display: inline-block;
            background: rgba(255,255,255,0.1); 
            color: #fff; 
            padding: 6px 12px; 
            border-radius: 8px; 
            font-size: 11px; 
            font-weight: 800; 
            margin-right: 6px;
            text-align: center; 
            border: 1px solid rgba(255,255,255,0.1); 
        }
        .h-badge.win { color: var(--emerald); border-color: var(--emerald); background: rgba(16, 185, 129, 0.1); }
        .h-badge.lose { color: var(--text-muted); }
        .h-badge.jackpot { color: var(--gold); border-color: var(--gold); background: rgba(245, 158, 11, 0.1); }
        
        .crash-overlay { position: absolute; inset: 0; display: flex; flex-direction: column; align-items: center; justify-content: center; pointer-events: none; z-index: 10; }
        .crash-mult-display { font-family: 'Courier New', monospace; font-size: 48px; font-weight: 900; color: #fff; text-shadow: 0 0 20px rgba(255,255,255,0.5); }
        .crash-status { font-size: 12px; letter-spacing: 2px; margin-bottom: 10px; color: var(--gold); text-transform: uppercase; }
        .loader-bar { width: 200px; height: 4px; background: rgba(255,255,255,0.1); border-radius: 4px; overflow: hidden; margin-top: 10px; }
        .loader-fill { height: 100%; background: var(--gold); width: 0%; }

        .modal { position: fixed; inset: 0; background: rgba(0,0,0,0.96); backdrop-filter: blur(20px); display: none; align-items: center; justify-content: center; z-index: 2000; padding: 15px; }
        .boss-card { background: linear-gradient(135deg, rgba(245,158,11,0.1), transparent); border: 1px solid var(--gold); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; box-shadow: 0 0 15px var(--gold-glow); }
    </style>
</head>
<body>

    <div id="toast-container"></div>
    
    <!-- SIDEBAR DRAWER -->
    <div id="sidebar-overlay" class="sidebar-overlay" onclick="toggleSidebar(false)"></div>
    <div id="game-sidebar" class="sidebar">
        <div style="display:flex; justify-content:space-between; align-items:center;">
            <h3 style="color:var(--text); font-weight:900;">GAME MENU</h3>
            <i data-lucide="x" onclick="toggleSidebar(false)" style="cursor:pointer; color:var(--text-muted);"></i>
        </div>
        <div style="flex:1; display: flex; flex-direction: column; gap: 10px;">
            <p style="font-size:11px; opacity:0.5; margin-bottom:10px;">OPTIONS</p>
            <button class="btn btn-outline" onclick="location.reload()" style="border-color:var(--text); color:var(--text);">
                <i data-lucide="refresh-cw"></i> REFRESH GAME
            </button>
            <button class="btn btn-outline" onclick="goHome()" style="border-color:var(--gold); color:var(--gold);">
                <i data-lucide="home"></i> EXIT TO LOBBY
            </button>
        </div>
        <p style="font-size:10px; text-align:center; opacity:0.3;">NEON ELITE SYSTEM</p>
    </div>

    <!-- AUDIO ASSETS -->
    <audio id="bg-music" src="bg_music.mp3" loop></audio>
    <audio id="sfx-fly" src="fly_away.mp3"></audio>

    <!-- System Screens -->
    <section id="loading-screen">
        <svg class="logo-glow" viewBox="0 0 100 100"><polygon points="50,5 95,25 95,75 50,95 5,75 5,25" fill="none" stroke="#f59e0b" stroke-width="3"/><path d="M30 40 L50 20 L70 40 L50 80 Z" fill="#f59e0b"/></svg>
        <h2 style="color: var(--gold); letter-spacing: 5px; margin-top: 20px; font-weight: 900;">NEON ELITE</h2>
    </section>

    <section id="banned-screen">
        <i data-lucide="shield-off" style="width:60px; height:60px; color: var(--ruby); margin-bottom: 20px;"></i>
        <h2 style="color: var(--ruby); margin-bottom: 10px; font-weight: 900;">ACCESS TERMINATED</h2>
        <p style="opacity: 0.7; font-size: 13px; max-width: 300px;">Your account has been permanently removed by the administrator.</p>
        <button class="btn btn-outline" style="margin-top: 30px; border-color: var(--ruby); color: var(--ruby);" onclick="location.reload()">Refresh System</button>
    </section>

    <!-- Approval Modal -->
    <div id="approval-modal" class="modal">
        <div class="modern-card" style="text-align:center; border-color:var(--emerald);">
            <div style="background:rgba(16,185,129,0.1); width:70px; height:70px; border-radius:50%; display:flex; align-items:center; justify-content:center; margin:0 auto 20px;">
                <i data-lucide="check-circle" style="width:40px; height:40px; color:var(--emerald);"></i>
            </div>
            <h2 style="color:var(--emerald); font-weight:900; margin-bottom:10px;">APPROVED!</h2>
            <p style="font-size:13px; margin-bottom:20px;">Transaction approved by Admin.</p>
            <h1 id="approved-amount" style="color:var(--text); font-size:32px; font-weight:900;">Rs. 0</h1>
            <button class="btn btn-primary" style="margin-top:20px;" onclick="document.getElementById('approval-modal').style.display='none'">OK</button>
        </div>
    </div>

    <!-- Txn Modal -->
    <div id="txn-modal" class="modal">
        <div class="modern-card" style="width: 100%;">
            <div id="deposit-boss-info" style="display: none;">
                <div class="boss-card">
                    <p style="font-size: 10px; color: var(--gold); letter-spacing: 2px;">OFFICIAL RECEIVER</p>
                    <h2 style="color: #fff; margin: 5px 0;">+923284378937</h2>
                    <p style="font-size: 14px; font-weight: 800;">Name: UMEED UMEED</p>
                </div>
            </div>
            <div style="display:flex; justify-content: space-between; margin-bottom:20px;">
                <h3 id="modal-title" style="font-size: 16px; font-weight: 900; color:var(--text);">REQUEST</h3>
                <i data-lucide="x-circle" onclick="closeModal()" style="cursor:pointer; opacity: 0.5; color:var(--text);"></i>
            </div>
            <div class="field"><i data-lucide="hash"></i><input type="number" id="txn-amount" placeholder="Amount (PKR)"></div>
            <div class="field"><i data-lucide="user"></i><input type="text" id="txn-name" placeholder="Account Name"></div>
            <div class="field"><i data-lucide="building"></i><select id="txn-bank" style="padding-left: 45px;"><option value="EasyPaisa">EasyPaisa</option><option value="JazzCash">JazzCash</option></select></div>
            <div class="field"><i data-lucide="phone"></i><input type="text" id="txn-number" placeholder="Mobile / TID"></div>
            <button class="btn btn-gold" onclick="submitTransaction()"><i data-lucide="send"></i> Authorize Transfer</button>
        </div>
    </div>

    <!-- Auth -->
    <section id="auth-screen">
        <div class="modern-card">
            <h2 id="auth-title" style="text-align:center; margin-bottom:25px; letter-spacing: 3px; font-weight: 900; color: var(--gold);">CREATE ACCOUNT</h2>
            <div class="field"><i data-lucide="mail"></i><input type="email" id="auth-email" placeholder="Gmail Only"></div>
            <div class="field"><i data-lucide="lock"></i><input type="password" id="auth-pass" placeholder="Password"></div>
            
            <div id="signup-extra">
                <div class="field"><i data-lucide="message-circle"></i><input type="text" id="auth-wa" placeholder="WhatsApp Number"></div>
                <div class="field"><i data-lucide="users"></i><input type="text" id="auth-referral" placeholder="Referral Code (Optional)"></div>
                
                <div class="checkbox-container">
                    <input type="checkbox" id="auth-terms">
                    <label for="auth-terms">I agree to the <a href="https://neon-terms-conditions-app.vercel.app" target="_blank">Terms & Conditions</a></label>
                </div>
            </div>

            <div id="signup-btns">
                <button class="btn btn-gold" onclick="handleAuth('signup')"><i data-lucide="check-circle"></i> Complete Signup</button>
                <button class="btn btn-outline" style="margin-top:10px;" onclick="toggleAuthMode('login')">Already have an account? Login</button>
            </div>

            <div id="auth-btns" style="display: none;">
                <button class="btn btn-primary" onclick="handleAuth('login')"><i data-lucide="log-in"></i> Secure Sign In</button>
                <button class="btn btn-outline" style="margin-top:10px;" onclick="toggleAuthMode('signup')">Create New Account</button>
            </div>
            <p id="auth-error" style="color:var(--ruby); font-size:10px; margin-top:15px; text-align:center;"></p>
        </div>
    </section>

    <!-- App Main Interface -->
    <div id="app-interface">
        <header>
            <div style="display:flex; align-items:center; gap:15px;">
                <div style="display:flex; align-items:center; gap:8px;">
                    <i data-lucide="crown" style="color:var(--gold); width:18px;"></i>
                    <span style="font-weight:900; font-size:13px; letter-spacing:1px; color:var(--text);">NEON ELITE</span>
                </div>
            </div>
            <div class="bal-pill">
                <i data-lucide="wallet" style="width:16px;"></i>
                Rs. <span id="header-bal">0.00</span>
                <i data-lucide="refresh-cw" id="ref-btn" style="width:14px; cursor:pointer;" onclick="refreshBal()"></i>
            </div>
        </header>

        <main>
            <!-- DASHBOARD -->
            <div id="view-home" class="view active"></div>

            <!-- REFERRAL VIEW -->
            <div id="view-refer" class="view">
                <div class="modern-card" style="text-align:center; margin-bottom:20px;">
                    <i data-lucide="gift" style="width:40px; height:40px; color:var(--gold); margin-bottom:10px;"></i>
                    <h2 style="color:var(--text); margin-bottom:5px;">REFER TO EARN</h2>
                    <p style="font-size:11px; color:var(--text-muted);">Get +1 Spin for every friend who joins.</p>
                </div>
                <div class="modern-card" style="margin-bottom:20px;">
                    <p style="font-size:10px; opacity:0.5; margin-bottom:5px;">YOUR REFERRAL LINK</p>
                    <div style="background:var(--bg); padding:15px; border-radius:12px; border:1px dashed var(--gold); display:flex; justify-content:space-between; align-items:center;">
                        <h3 id="ref-code-display" style="color:var(--gold); font-size: 11px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 200px;">LOADING...</h3>
                        <i data-lucide="copy" style="cursor:pointer; opacity:0.7;" onclick="copyReferral()"></i>
                    </div>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                    <div class="modern-card" style="padding:15px; text-align:center; width:100%;">
                        <h1 id="ref-count" style="color:var(--emerald);">0</h1>
                        <p style="font-size:9px; opacity:0.5;">TOTAL REFERRALS</p>
                    </div>
                    <div class="modern-card" style="padding:15px; text-align:center; width:100%;">
                        <h1 id="ref-earn" style="color:var(--gold);">Rs. 0</h1>
                        <p style="font-size:9px; opacity:0.5;">EARNINGS</p>
                    </div>
                </div>
            </div>

            <!-- SPIN WHEEL VIEW -->
            <div id="view-spin" class="view">
                <div class="modern-card" style="text-align:center; margin-bottom:20px;">
                    <i data-lucide="aperture" style="width:30px; height:30px; color:var(--neon-pink); animation: spin 3s linear infinite;"></i>
                    <h2 style="color:var(--text); margin:10px 0;">NEON WHEEL</h2>
                    <p style="font-size:11px; color:var(--text-muted);">2 Free Spins Daily. Refer friends for more!</p>
                    <p style="font-size:12px; margin-top:10px; color:var(--gold); font-weight:bold;">Spins Available: <span id="spins-available">0</span></p>
                </div>

                <div class="wheel-container">
                    <div class="wheel-pointer"></div>
                    <div class="wheel-outer" id="wheel-outer">
                        <div class="wheel-bg"></div>
                        <div class="wheel-center"></div>
                        <div class="wheel-text" style="transform: rotate(22.5deg);"><span class="w-label">+5</span></div>
                        <div class="wheel-text" style="transform: rotate(67.5deg);"><span class="w-label">-5</span></div>
                        <div class="wheel-text" style="transform: rotate(112.5deg);"><span class="w-label">+3</span></div>
                        <div class="wheel-text" style="transform: rotate(157.5deg);"><span class="w-label">-3</span></div>
                        <div class="wheel-text" style="transform: rotate(202.5deg);"><span class="w-label">+1</span></div>
                        <div class="wheel-text" style="transform: rotate(247.5deg);"><span class="w-label">-1</span></div>
                        <div class="wheel-text" style="transform: rotate(292.5deg);"><span class="w-label">SPIN</span></div>
                        <div class="wheel-text" style="transform: rotate(337.5deg);"><span class="w-label" style="font-size:12px;">ðŸ˜­</span></div>
                    </div>
                </div>

                <div style="text-align:center; margin-top:20px;">
                    <button id="btn-spin" class="btn btn-gold" style="width:200px; margin:0 auto;" onclick="spinWheel()">SPIN NOW</button>
                    <p id="spin-msg" style="margin-top:15px; font-size:12px; font-weight:bold;"></p>
                </div>
            </div>

            <!-- SETTINGS VIEW -->
            <div id="view-settings" class="view">
                <div class="modern-card" style="width:100%;">
                    <h3 style="margin-bottom:20px; color:var(--text);"><i data-lucide="settings" style="width:18px; display:inline; margin-right:5px;"></i> SETTINGS</h3>
                    <div style="display:flex; justify-content:space-between; align-items:center; padding:15px 0; border-bottom:1px solid var(--border);">
                        <div><h5 style="color:var(--text);">Theme</h5><p style="font-size:10px; color:var(--text-muted);">Switch light/dark mode</p></div>
                        <label class="switch"><input type="checkbox" id="theme-toggle" onchange="toggleTheme()"><span class="slider"></span></label>
                    </div>
                    <button class="btn btn-outline" style="margin-top:30px; border-color:var(--ruby); color:var(--ruby);" onclick="auth.signOut()"><i data-lucide="log-out"></i> Sign Out</button>
                </div>
            </div>

            <!-- GAME VIEWS (FULL SCREEN) -->
            <div id="view-mines" class="view">
                <div class="game-view-container">
                    <div class="game-menu-btn" onclick="toggleSidebar(true)"><i data-lucide="align-left" style="width:20px;"></i></div>
                    <div class="game-balance-pill"><i data-lucide="wallet" style="width:14px;"></i> <span class="live-balance-display">0.00</span></div>
                    
                    <div class="modern-card" style="width:100%; margin-bottom:20px; padding:20px;">
                        <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                            <div><label style="font-size:9px; opacity:0.5;">BET</label><input type="number" id="mine-bet" value="50"></div>
                            <div><label style="font-size:9px; opacity:0.5;">MINES</label><input type="number" id="mine-count" value="3"></div>
                        </div>
                        <button class="btn btn-primary" id="btn-m-start" onclick="startMines()"><i data-lucide="play"></i> Start Mines</button>
                        <button class="btn btn-gold" id="btn-m-cash" style="display:none;" onclick="cashoutMines()"><i data-lucide="banknote"></i> Cash Out</button>
                    </div>
                    <div id="mine-status" style="text-align:center; color:var(--gold); font-weight:900; font-size:14px; margin-bottom:15px;"></div>
                    <div class="mines-grid" id="mines-grid"></div>
                </div>
            </div>

            <div id="view-bricks" class="view">
                <div class="game-view-container">
                    <div class="game-menu-btn" onclick="toggleSidebar(true)"><i data-lucide="align-left" style="width:20px;"></i></div>
                    <div class="game-balance-pill"><i data-lucide="wallet" style="width:14px;"></i> <span class="live-balance-display">0.00</span></div>

                    <div class="modern-card" style="width:100%; margin-bottom:15px; padding:15px;">
                        <label style="font-size:10px; opacity:0.5;">BET AMOUNT</label>
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <input type="number" id="brick-bet" value="50" style="margin-bottom:0;">
                            <button class="btn btn-primary" id="btn-b-start" style="width:120px;" onclick="startBricks()"><i data-lucide="arrow-up-circle"></i> Start</button>
                            <button class="btn btn-gold" id="btn-b-cash" style="display:none; width:120px;" onclick="cashoutBricks()"><i data-lucide="dollar-sign"></i> Cashout</button>
                        </div>
                    </div>
                    <div id="brick-status" style="text-align:center; color:var(--gold); font-weight:900; font-size:12px; margin-bottom:5px;">Next: Row 1</div>
                    <div class="tower-wrap" id="tower-container"><div id="ball"></div></div>
                </div>
            </div>

            <!-- PLINKO GAME VIEW (PROFESSIONAL CANVAS) -->
            <div id="view-plinko" class="view">
                <div class="game-view-container">
                    <div class="game-menu-btn" onclick="toggleSidebar(true)"><i data-lucide="align-left" style="width:20px;"></i></div>
                    <div class="game-balance-pill"><i data-lucide="wallet" style="width:14px;"></i> <span class="live-balance-display">0.00</span></div>

                    <div id="plinko-container">
                        <canvas id="plinko-canvas"></canvas>
                    </div>

                    <div class="modern-card" style="width:100%; padding: 15px;">
                        <div style="display:flex; gap:10px; align-items:flex-end;">
                            <div style="flex:1;">
                                <label style="font-size:10px; opacity:0.5;">BET AMOUNT</label>
                                <input type="number" id="plinko-bet" value="50" style="margin-bottom:0;">
                            </div>
                            <button class="btn btn-primary" id="btn-plinko-drop" style="flex:1;" onclick="dropPlinkoBall()"><i data-lucide="arrow-down-circle"></i> DROP BALL</button>
                        </div>
                    </div>
                </div>
            </div>

            <div id="view-crash" class="view">
                <div class="game-view-container">
                    <div class="game-menu-btn" onclick="toggleSidebar(true)"><i data-lucide="align-left" style="width:20px;"></i></div>
                    <div class="game-balance-pill"><i data-lucide="wallet" style="width:14px;"></i> <span class="live-balance-display">0.00</span></div>

                    <div id="crash-stage">
                        <canvas id="crash-canvas"></canvas>
                        <div class="crash-overlay">
                            <div id="crash-msg" class="crash-status">WAITING FOR ROUND</div>
                            <div id="crash-value" class="crash-mult-display">0.00x</div>
                            <div class="loader-bar" id="crash-loader" style="display:none;">
                                <div class="loader-fill" id="crash-fill"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="modern-card" style="width:100%; padding: 15px; margin-top: 10px;">
                        <div style="display:flex; justify-content:space-between; margin-bottom:5px;">
                            <label style="font-size:9px; opacity:0.5;">BET AMOUNT</label>
                            <label style="font-size:9px; opacity:0.5;">AUTO CASH (OPTIONAL)</label>
                        </div>
                        <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                            <input type="number" id="crash-bet" value="50" placeholder="Bet">
                            <input type="number" id="crash-auto" value="2.0" placeholder="Auto x">
                        </div>
                        <button class="btn btn-crash" id="btn-crash-action" onclick="handleCrashAction()"><i data-lucide="rocket"></i> PLACE BET</button>
                    </div>
                    
                    <!-- CRASH HISTORY MOVED HERE -->
                    <div class="crash-history-container" id="crash-history"></div>
                </div>
            </div>

            <div id="view-profile" class="view">
                <div class="modern-card" style="width:100%; text-align:center; margin-bottom:20px;">
                    <p style="opacity:0.5; font-size:10px;">WALLET BALANCE</p>
                    <h1 style="color:var(--emerald); margin:10px 0; font-size:36px; font-weight:900;">Rs. <span id="prof-bal">0.00</span></h1>
                </div>
                <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px; margin-bottom:15px;">
                    <button class="btn btn-primary" onclick="openModal('Deposit')"><i data-lucide="plus"></i> Deposit</button>
                    <button id="withdraw-btn-main" class="btn btn-gold" style="display:none" onclick="openModal('Withdraw')"><i data-lucide="arrow-down-to-line"></i> Withdraw</button>
                </div>
                <div id="withdraw-locked" style="background:rgba(239,68,68,0.05); border:1px dashed var(--ruby); padding:20px; border-radius:20px; text-align:center;">
                    <p style="font-size:11px; color:var(--ruby); font-weight:900;"><i data-lucide="lock" style="width:14px;"></i> WITHDRAW LOCKED</p>
                    <p style="font-size:10px; opacity:0.5; margin-top:5px;">500 PKR balance required.</p>
                </div>
            </div>
        </main>

        <nav>
            <div class="nav-item active" id="nav-home" onclick="switchTab('home')"><i data-lucide="home"></i><span>Home</span></div>
            <div class="nav-item" id="nav-spin" onclick="switchTab('spin')"><i data-lucide="aperture"></i><span>Spin</span></div>
            <div class="nav-item" id="nav-refer" onclick="switchTab('refer')"><i data-lucide="users"></i><span>Refer</span></div>
            <div class="nav-item" id="nav-profile" onclick="switchTab('profile')"><i data-lucide="wallet"></i><span>Wallet</span></div>
            <div class="nav-item" id="nav-settings" onclick="switchTab('settings')"><i data-lucide="settings"></i><span>Settings</span></div>
        </nav>
    </div>

    <script>
        // --- 1. CONFIGURATION ---
        const firebaseConfig = {
            apiKey: "AIzaSyA3D_1IRdpPB_2rmF5rtGqvJ1EXFNF2zxc",
            authDomain: "alarix-61e90.firebaseapp.com",
            databaseURL: "https://alarix-61e90-default-rtdb.firebaseio.com",
            projectId: "alarix-61e90",
            storageBucket: "alarix-61e90.firebasestorage.app",
            messagingSenderId: "747193234958",
            appId: "1:747193234958:web:c69501009d5950b63d6e5f",
            measurementId: "G-DV5XBRC8L1"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        const WHATSAPP_SUPPORT = "+923140943604";
        let userData = null;
        let audioCtx = new (window.AudioContext || window.webkitAudioContext)();

        // --- 2. STARTUP LOGIC ---
        window.onload = function() {
            const urlParams = new URLSearchParams(window.location.search);
            const refParam = urlParams.get('ref');
            const hashRef = window.location.hash.substring(1);
            const finalRef = refParam || hashRef;

            if (finalRef && finalRef.length > 5) {
                document.getElementById('auth-referral').value = finalRef;
                document.getElementById('app-interface').style.display = 'none';
                document.getElementById('auth-screen').style.display = 'flex';
                toast("Referral Code Applied!");
            }
        };

        // --- 3. DASHBOARD CAROUSEL ---
        const proofs = [
            { txt: "DEPOSIT", img: "https://images.unsplash.com/photo-1518546305927-5a555bb7020d?auto=format&fit=crop&w=600&q=80" },
            { txt: "WITHDRAW", img: "https://images.unsplash.com/photo-1559526324-4b87b5e36e44?auto=format&fit=crop&w=600&q=80" },
            { txt: "BIG WIN", img: "https://images.unsplash.com/photo-1605901309584-818e25960b8f?auto=format&fit=crop&w=600&q=80" },
            { txt: "JACKPOT", img: "https://images.unsplash.com/photo-1518133910546-b6c2fb7d79e3?auto=format&fit=crop&w=600&q=80" },
            { txt: "VIP", img: "https://images.unsplash.com/photo-1639322537228-f710d846310a?auto=format&fit=crop&w=600&q=80" }
        ];

        function initCarousel() {
            const track = document.getElementById('dash-track');
            if(!track) return;
            track.innerHTML = '';
            proofs.forEach(p => {
                const div = document.createElement('div');
                div.className = 'carousel-slide';
                div.innerHTML = `<img src="${p.img}" onerror="this.src='https://via.placeholder.com/600x300?text=GAME+PROOF'"><div class="carousel-content"><span class="proof-badge">${p.txt}</span><div class="proof-text">SUCCESSFUL</div></div>`;
                track.appendChild(div);
            });
            let index = 0;
            setInterval(() => {
                index++;
                if (index >= proofs.length) index = 0;
                track.style.transform = `translateX(-${index * 100}%)`;
            }, 3000);
        }

        // --- 4. CORE FUNCTIONS ---
        function toggleSidebar(show) {
            const sb = document.getElementById('game-sidebar');
            const ol = document.getElementById('sidebar-overlay');
            if(show) { sb.classList.add('open'); ol.classList.add('active'); } 
            else { sb.classList.remove('open'); ol.classList.remove('active'); }
        }

        function goHome() {
            toggleSidebar(false);
            stopGameSounds();
            switchTab('home');
        }

        function toggleTheme() {
            const isChecked = document.getElementById('theme-toggle').checked;
            const meta = document.querySelector('meta[name="theme-color"]');
            
            if(isChecked) {
                document.documentElement.setAttribute('data-theme', 'light');
                if(meta) meta.setAttribute("content", "#f1f5f9");
            } else {
                document.documentElement.removeAttribute('data-theme');
                if(meta) meta.setAttribute("content", "#020406");
            }
        }

        const bgMusic = document.getElementById('bg-music');
        const sfxFly = document.getElementById('sfx-fly');
        bgMusic.volume = 0.4;

        function sfx(type) {
            if(audioCtx.state === 'suspended') audioCtx.resume();
            if (type === 'engine_start') { bgMusic.currentTime = 0; bgMusic.play().catch(()=>{}); } 
            else if (type === 'engine_stop') { bgMusic.pause(); }
            else if (type === 'crash_fly') { sfxFly.currentTime = 0; sfxFly.play().catch(()=>{}); }
            else {
                const osc = audioCtx.createOscillator();
                const g = audioCtx.createGain();
                osc.connect(g); g.connect(audioCtx.destination);
                g.gain.setValueAtTime(0.1, audioCtx.currentTime);
                if(type==='win'){ osc.type='sine'; osc.frequency.setValueAtTime(500,audioCtx.currentTime); osc.frequency.exponentialRampToValueAtTime(1200,audioCtx.currentTime+0.3); g.gain.linearRampToValueAtTime(0,audioCtx.currentTime+0.3); }
                else if(type==='lose'){ osc.type='sawtooth'; osc.frequency.setValueAtTime(150,audioCtx.currentTime); osc.frequency.linearRampToValueAtTime(50,audioCtx.currentTime+0.3); g.gain.exponentialRampToValueAtTime(0.01,audioCtx.currentTime+0.3); }
                else { osc.type='sine'; osc.frequency.setValueAtTime(400,audioCtx.currentTime); }
                osc.start(); osc.stop(audioCtx.currentTime + (type==='win'||type==='lose'?0.3:0.1));
            }
        }

        function stopGameSounds() {
            bgMusic.pause(); bgMusic.currentTime = 0;
            sfxFly.pause(); sfxFly.currentTime = 0;
        }

        function toast(msg, type='success') {
            const container = document.getElementById('toast-container');
            const el = document.createElement('div'); el.className = `toast ${type}`;
            el.innerHTML = `<i data-lucide="bell" style="width:18px;"></i> <span>${msg}</span>`;
            container.appendChild(el); lucide.createIcons();
            gsap.to(el, { opacity:1, y:0, duration:0.4 });
            setTimeout(() => gsap.to(el, { opacity:0, y:-20, duration:0.4, onComplete:()=>el.remove() }), 3000);
        }

        // --- 5. AUTH & LOGIC ---
        auth.onAuthStateChanged((user) => {
            if (user) {
                db.collection('users').doc(user.uid).onSnapshot((doc) => {
                    if (!doc.exists) {
                        auth.signOut();
                        document.getElementById('banned-screen').style.display = 'flex';
                        return;
                    }
                    userData = doc.data();
                    userData.uid = user.uid;
                    // --- SPIN INIT LOGIC ---
                    if(!userData.spinData) userData.spinData = { count: 0, date: "" };
                    if(!userData.extraSpins) userData.extraSpins = 0;
                    
                    updateUI();
                    document.getElementById('auth-screen').style.display = 'none';
                    document.getElementById('app-interface').style.display = 'flex';
                    document.getElementById('loading-screen').style.display = 'none';
                    initCarousel();
                });

                db.collection('requests')
                    .where('uid', '==', user.uid)
                    .where('status', '==', 'approved')
                    .onSnapshot(snapshot => {
                        snapshot.docChanges().forEach(change => {
                            if (change.type === 'modified') {
                                const data = change.doc.data();
                                document.getElementById('approved-amount').innerText = "Rs. " + data.amount;
                                document.getElementById('approval-modal').style.display = 'flex';
                                sfx('win'); confetti();
                            }
                        });
                    });

            } else {
                document.getElementById('app-interface').style.display = 'none';
                document.getElementById('auth-screen').style.display = 'flex';
                document.getElementById('loading-screen').style.display = 'none';
                showSignupFields(); 
            }
        });

        async function handleAuth(type) {
            const e = document.getElementById('auth-email').value.toLowerCase().trim();
            const p = document.getElementById('auth-pass').value;
            
            if(!e || !p) return toast("Fill fields", "error");

            try {
                if (type === 'signup') {
                    const terms = document.getElementById('auth-terms').checked;
                    if (!terms) return toast("Agree to Terms first", "error");

                    const wa = document.getElementById('auth-wa').value.trim();
                    const refCode = document.getElementById('auth-referral').value.trim();
                    if(!e.endsWith('@gmail.com')) return toast("Gmail only", "error");

                    const cred = await auth.createUserWithEmailAndPassword(e, p);
                    
                    await db.collection('users').doc(cred.user.uid).set({ 
                        balance: 0, email: e, whatsapp: wa, isVerified: false,
                        referredBy: refCode || null, referralEarnings: 0, totalReferrals: 0,
                        spinData: { count: 0, date: new Date().toDateString() },
                        extraSpins: 0,
                        joinDate: firebase.firestore.FieldValue.serverTimestamp()
                    });

                    // REFERRAL BONUS LOGIC (+5 PKR and +1 Spin for referrer)
                    if (refCode) {
                        const refDoc = await db.collection('users').doc(refCode).get();
                        if(refDoc.exists) {
                            await db.collection('users').doc(refCode).update({
                                balance: firebase.firestore.FieldValue.increment(5),
                                referralEarnings: firebase.firestore.FieldValue.increment(5),
                                totalReferrals: firebase.firestore.FieldValue.increment(1),
                                extraSpins: firebase.firestore.FieldValue.increment(1) // Extra Spin Added
                            });
                            toast("Referral Bonus Added!", "success");
                        }
                    }
                } else await auth.signInWithEmailAndPassword(e, p);
            } catch (err) { toast(err.message, "error"); }
        }

        function toggleAuthMode(mode) {
            if(mode === 'login') {
                document.getElementById('signup-extra').style.display = 'none';
                document.getElementById('signup-btns').style.display = 'none';
                document.getElementById('auth-btns').style.display = 'block';
                document.getElementById('auth-title').innerText = "MEMBER LOGIN";
            } else {
                document.getElementById('signup-extra').style.display = 'block';
                document.getElementById('signup-btns').style.display = 'block';
                document.getElementById('auth-btns').style.display = 'none';
                document.getElementById('auth-title').innerText = "CREATE ACCOUNT";
            }
        }

        function showSignupFields() {
            toggleAuthMode('signup');
        }

        function updateUI() {
            if(!userData) return;
            const b = userData.balance || 0;
            const formattedBal = b.toFixed(2);
            
            document.getElementById('header-bal').innerText = formattedBal;
            document.getElementById('prof-bal').innerText = formattedBal;
            document.querySelectorAll('.live-balance-display').forEach(el => el.innerText = formattedBal);

            document.getElementById('withdraw-btn-main').style.display = (b >= 500) ? 'flex' : 'none';
            document.getElementById('withdraw-locked').style.display = (b >= 500) ? 'none' : 'block';
            document.getElementById('ref-code-display').innerText = `https://neonelite-casino.vercel.app/?ref=${userData.uid}`;
            document.getElementById('ref-earn').innerText = "Rs. " + (userData.referralEarnings || 0).toFixed(2);
            document.getElementById('ref-count').innerText = userData.totalReferrals || 0;

            // --- SPIN UI UPDATE ---
            const today = new Date().toDateString();
            const lastDate = userData.spinData?.date || "";
            let dailyUsed = (lastDate === today) ? userData.spinData.count : 0;
            let available = 0;
            
            if(dailyUsed < 2) available = 2 - dailyUsed;
            else available = userData.extraSpins || 0;
            
            document.getElementById('spins-available').innerText = (dailyUsed < 2) ? `${available} (Daily) + ${userData.extraSpins} (Extra)` : available;

            const home = document.getElementById('view-home');
            if(!userData.isVerified) {
                home.innerHTML = `<div class="modern-card" style="text-align:center; border-color:var(--gold);">
                    <i data-lucide="shield-check" style="width:50px; height:50px; color:var(--gold); margin-bottom:15px;"></i>
                    <h3>ACCOUNT UNVERIFIED</h3>
                    <p style="font-size:11px; opacity:0.6; margin-bottom:20px;">Verify your WhatsApp <b>${userData.whatsapp}</b> to claim Rs. 177 Bonus.</p>
                    <button class="btn btn-gold" onclick="verifyWhatsApp()"><i data-lucide="message-circle"></i> Verify on WhatsApp</button>
                </div>`;
            } else {
                // --- UPDATED IMAGES FOR HOME ---
                home.innerHTML = `
                <div class="carousel-container"><div class="carousel-track" id="dash-track"></div></div>
                <p style="font-size:10px; margin-bottom:15px; font-weight:800; color:var(--text); opacity:0.6; letter-spacing:1px;">POPULAR GAMES</p>
                <div class="games-grid">
                    <div class="g-card" onclick="switchTab('crash')">
                        <div class="g-icon" style="padding:0; overflow:hidden;">
                            <img src="https://i.ibb.co/9HBFrrP3/featured-image-2024-11-28-T191534-766.png" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div class="g-info"><h5 class="g-title">Neon Crash</h5><div class="g-footer"><span class="play-tag"><i data-lucide="play" style="width:8px;"></i> PLAY</span><span class="live-users"><div class="live-dot"></div> 842</span></div></div>
                    </div>
                    <div class="g-card" onclick="switchTab('mines')">
                        <div class="g-icon" style="padding:0; overflow:hidden;">
                            <img src="https://i.ibb.co/nsFh25cb/tile-large.jpg" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div class="g-info"><h5 class="g-title">Mines</h5><div class="g-footer"><span class="play-tag"><i data-lucide="play" style="width:8px;"></i> PLAY</span><span class="live-users"><div class="live-dot"></div> 1.2k</span></div></div>
                    </div>
                    <div class="g-card" onclick="switchTab('bricks')">
                        <div class="g-icon" style="padding:0; overflow:hidden;">
                            <img src="https://i.ibb.co/m5K4KG9D/Tower.jpg" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div class="g-info"><h5 class="g-title">Tower</h5><div class="g-footer"><span class="play-tag"><i data-lucide="play" style="width:8px;"></i> PLAY</span><span class="live-users"><div class="live-dot"></div> 590</span></div></div>
                    </div>
                    <!-- PLINKO CARD -->
                    <div class="g-card" onclick="switchTab('plinko')">
                        <div class="g-icon" style="padding:0; overflow:hidden; background:#111;">
                            <img src="https://i.ibb.co/SXpTqMW8/com-jogo-luckyplinko-icon-2023-08-20-09-31-32.png" style="width:100%; height:100%; object-fit:cover;">
                        </div>
                        <div class="g-info"><h5 class="g-title">Plinko</h5><div class="g-footer"><span class="play-tag"><i data-lucide="play" style="width:8px;"></i> PLAY</span><span class="live-users"><div class="live-dot"></div> 999</span></div></div>
                    </div>
                </div>`;
            }
            lucide.createIcons();
        }

        function copyReferral() {
            const link = `https://neonelite-casino.vercel.app/?ref=${userData.uid}`;
            if (navigator.clipboard && navigator.clipboard.writeText) {
                navigator.clipboard.writeText(link).then(() => toast("Link Copied!")).catch(() => fallbackCopy(link));
            } else { fallbackCopy(link); }
        }

        function fallbackCopy(text) {
            const textArea = document.createElement("textarea"); textArea.value = text;
            document.body.appendChild(textArea); textArea.select();
            try { document.execCommand('copy'); toast("Link Copied!"); } catch (err) { toast("Copy Failed", "error"); }
            document.body.removeChild(textArea);
        }

        // --- 6. TRANSACTIONS ---
        let txnMode = 'Deposit';
        function openModal(mode) {
            txnMode = mode;
            document.getElementById('modal-title').innerText = mode.toUpperCase();
            document.getElementById('deposit-boss-info').style.display = (mode==='Deposit')?'block':'none';
            document.getElementById('txn-modal').style.display = 'flex';
        }
        function closeModal() { document.getElementById('txn-modal').style.display = 'none'; }

        async function sync(amount) {
            await db.collection('users').doc(auth.currentUser.uid).update({ balance: firebase.firestore.FieldValue.increment(amount) });
        }

        async function submitTransaction() {
            const amt = parseFloat(document.getElementById('txn-amount').value);
            const name = document.getElementById('txn-name').value;
            const bank = document.getElementById('txn-bank').value;
            const num = document.getElementById('txn-number').value;
            if(!amt || amt <= 0 || !name || !num) return toast("Invalid Details", "error");
            if(txnMode === 'Withdraw' && amt > userData.balance) return toast("Insufficient Funds", "error");
            if(txnMode === 'Withdraw') await sync(-amt);
            await db.collection('requests').add({ uid: auth.currentUser.uid, email: userData.email, amount: amt, name, bank, number: num, type: txnMode, status: 'pending', timestamp: firebase.firestore.FieldValue.serverTimestamp() });
            const msg = `ðŸŽ° *NEON ELITE REQUEST*\nType: ${txnMode}\nAmount: ${amt}\nBank: ${bank}\nAccount: ${num}\nName: ${name}\nUser: ${userData.email}`;
            window.open(`https://wa.me/${WHATSAPP_SUPPORT}?text=${encodeURIComponent(msg)}`, '_blank');
            closeModal(); toast("Request Submitted", "success");
        }

        function verifyWhatsApp() {
            const msg = `ðŸŽ° *VERIFY REQUEST*\nEmail: ${userData.email}\nWA: ${userData.whatsapp}\nPlease verify and add 177 bonus.`;
            window.open(`https://wa.me/${WHATSAPP_SUPPORT}?text=${encodeURIComponent(msg)}`, '_blank');
        }

        async function refreshBal() {
            gsap.to("#ref-btn", { rotation: "+=360", duration: 0.6 });
            toast("Balance Synced", "success");
        }

        function switchTab(t) {
            if(t!=='home' && t!=='profile' && t!=='settings' && t!=='refer' && t!=='spin' && !userData.isVerified) return toast("Verify First!", "error");
            const body = document.body;
            if (t === 'crash' || t === 'mines' || t === 'bricks' || t === 'plinko') { body.classList.add('game-mode'); } 
            else { body.classList.remove('game-mode'); stopGameSounds(); stopCrashGame(); stopPlinko(); }
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
            document.getElementById('view-' + t).classList.add('active');
            let navId = 'nav-home';
            if(t==='profile') navId='nav-profile'; 
            else if(t==='settings') navId='nav-settings'; 
            else if(t==='refer') navId='nav-refer';
            else if(t==='spin') navId='nav-spin';
            
            if(['home','profile','settings','refer', 'spin'].includes(t)){ document.getElementById(navId).classList.add('active'); }
            resetMines(); resetBricks();
            if(t==='crash') { if(!window.crashGameRunning) initCrashGame(); }
            if(t==='plinko') { initPlinko(); }
            lucide.createIcons();
        }

        // --- 7. GAMES ---
        
        // --- SPIN WHEEL LOGIC (8 Segments) ---
        const segments = [
            { label: "+5", type: 'win', val: 5 },
            { label: "-5", type: 'loss', val: -5 },
            { label: "+3", type: 'win', val: 3 },
            { label: "-3", type: 'loss', val: -3 },
            { label: "+1", type: 'win', val: 1 },
            { label: "-1", type: 'loss', val: -1 },
            { label: "Spin", type: 'free', val: 0 },
            { label: "ðŸ˜­", type: 'nothing', val: 0 }
        ];

        let isSpinning = false;
        async function spinWheel() {
            if(isSpinning) return;
            
            // Check eligibility
            const today = new Date().toDateString();
            const lastDate = userData.spinData?.date || "";
            let dailyUsed = (lastDate === today) ? userData.spinData.count : 0;
            let extra = userData.extraSpins || 0;
            let isDaily = false;

            if (dailyUsed < 2) {
                isDaily = true;
            } else if (extra > 0) {
                isDaily = false;
            } else {
                toast("No spins left! Refer friends.", "error");
                switchTab('refer');
                return;
            }

            isSpinning = true;
            document.getElementById('btn-spin').disabled = true;
            document.getElementById('spin-msg').innerText = "Spinning...";

            // Determine Random Segment
            const randIndex = Math.floor(Math.random() * 8);
            const segment = segments[randIndex];
            
            const sliceDeg = 45;
            const targetDeg = (randIndex * sliceDeg) + (sliceDeg/2); 
            
            const rotations = 360 * 5; 
            const endRot = rotations + (360 - targetDeg);

            const wheel = document.getElementById('wheel-outer');
            wheel.style.transform = `rotate(${endRot}deg)`;
            
            const tick = setInterval(() => { sfx('click'); }, 300);

            setTimeout(async () => {
                clearInterval(tick);
                isSpinning = false;
                document.getElementById('btn-spin').disabled = false;
                
                // Result Handling
                if(segment.type === 'win') {
                    await sync(segment.val);
                    toast(`Won ${segment.val} PKR!`, 'success');
                    sfx('win');
                    confetti();
                } else if (segment.type === 'loss') {
                    await sync(segment.val);
                    toast(`Lost ${Math.abs(segment.val)} PKR`, 'error');
                    sfx('lose');
                } else if (segment.type === 'free') {
                    toast("Free Spin! Spin again.", 'success');
                    await db.collection('users').doc(auth.currentUser.uid).update({
                        extraSpins: firebase.firestore.FieldValue.increment(1)
                    });
                } else {
                    toast("Oh no! Better luck next time.", 'error');
                    sfx('lose');
                }
                
                document.getElementById('spin-msg').innerText = segment.label === "Spin" ? "FREE SPIN!" : (segment.label === "ðŸ˜­" ? "NOTHING" : `${segment.label} PKR`);

                // Update Usage
                if(segment.type !== 'free') {
                    if (isDaily) {
                        await db.collection('users').doc(auth.currentUser.uid).update({
                            spinData: { count: dailyUsed + 1, date: today }
                        });
                    } else {
                        await db.collection('users').doc(auth.currentUser.uid).update({
                            extraSpins: firebase.firestore.FieldValue.increment(-1)
                        });
                    }
                }

                setTimeout(() => {
                    wheel.style.transition = 'none';
                    wheel.style.transform = `rotate(${360 - targetDeg}deg)`;
                    setTimeout(() => wheel.style.transition = 'transform 4s cubic-bezier(0.1, 0.9, 0.2, 1)', 50);
                }, 1000);

            }, 4000);
        }

        // --- CRASH GAME ---
        let crashReqId, crashCtx, crashCanvas;
        let crashState = 'WAITING'; let crashMult = 1.00; let crashTime = 0; let crashBet = 0; let crashAuto = 0; let crashMyBetActive = false; let crashNextBet = false; let crashStars = [];
        let crashHistory = [];
        window.crashGameRunning = false;
        
        function stopCrashGame() { window.crashGameRunning = false; cancelAnimationFrame(crashReqId); }
        function initCrashGame() { window.crashGameRunning = true; crashCanvas = document.getElementById('crash-canvas'); crashCtx = crashCanvas.getContext('2d'); resizeCrash(); window.addEventListener('resize', resizeCrash); crashStars = Array.from({length: 50}, () => ({x: Math.random()*crashCanvas.width, y: Math.random()*crashCanvas.height, s: Math.random()*2})); startCountdown(); loopCrash(); }
        function resizeCrash() { const rect = document.getElementById('crash-stage').getBoundingClientRect(); crashCanvas.width = rect.width; crashCanvas.height = rect.height; }
        
        function updateCrashHistory(m) {
            crashHistory.unshift(m); if(crashHistory.length > 20) crashHistory.pop();
            const bar = document.getElementById('crash-history'); bar.innerHTML = '';
            crashHistory.forEach(h => {
                const badge = document.createElement('div');
                badge.className = `h-badge ${h >= 10 ? 'jackpot' : h >= 2 ? 'win' : 'lose'}`;
                badge.innerText = h.toFixed(2) + 'x';
                bar.appendChild(badge);
            });
        }

        function loopCrash() {
            if(!window.crashGameRunning) return;
            crashCtx.fillStyle = '#050505'; crashCtx.fillRect(0, 0, crashCanvas.width, crashCanvas.height);
            crashCtx.strokeStyle = 'rgba(0, 243, 255, 0.1)'; crashCtx.lineWidth = 1; crashCtx.beginPath();
            const timeOffset = (Date.now() / 50) % 40; for(let i=0; i<crashCanvas.width; i+=40) { crashCtx.moveTo(i - timeOffset, 0); crashCtx.lineTo(i - timeOffset, crashCanvas.height); } for(let i=0; i<crashCanvas.height; i+=40) { crashCtx.moveTo(0, i); crashCtx.lineTo(crashCanvas.width, i); } crashCtx.stroke();
            crashCtx.fillStyle = '#fff'; crashStars.forEach(s => { s.x -= (0.5 + (crashState==='FLYING'? crashMult*1.5 : 0)); if(s.x < 0) s.x = crashCanvas.width; crashCtx.globalAlpha = Math.random(); crashCtx.beginPath(); crashCtx.arc(s.x, s.y, s.s, 0, Math.PI*2); crashCtx.fill(); }); crashCtx.globalAlpha = 1;
            if (crashState === 'FLYING') {
                crashTime += 0.016; crashMult = 1.00 + (Math.pow(1.025, crashTime * 10) - 1);
                document.getElementById('crash-value').innerText = crashMult.toFixed(2) + 'x'; document.getElementById('crash-value').style.color = '#fff';
                if(crashMyBetActive && crashAuto > 1 && crashMult >= crashAuto) { cashoutCrash(); }
                let crashProb = 0.003 + (crashTime * 0.0005); if (Math.random() < crashProb) { doCrash(); }
            }
            const w = crashCanvas.width; const h = crashCanvas.height; let progress = 0; if (crashState === 'FLYING' || crashState === 'CRASHED') progress = Math.min(1, (crashMult - 1) / 5);
            const jx = 50 + (progress * (w - 100)); const jy = h - 50 - (progress * (h - 100)); 
            if(crashState !== 'WAITING') {
                crashCtx.beginPath(); crashCtx.moveTo(0, h); crashCtx.quadraticCurveTo(jx/2, h, jx, jy); crashCtx.strokeStyle = '#00f3ff'; crashCtx.lineWidth = 3; crashCtx.stroke();
                const grad = crashCtx.createLinearGradient(0, 0, 0, h); grad.addColorStop(0, 'rgba(0, 243, 255, 0.2)'); grad.addColorStop(1, 'rgba(0, 243, 255, 0)'); crashCtx.lineTo(jx, h); crashCtx.lineTo(0, h); crashCtx.fillStyle = grad; crashCtx.fill();
            }
            if (crashState !== 'CRASHED') {
                crashCtx.save(); crashCtx.translate(jx, jy); crashCtx.rotate(-0.5); crashCtx.font = "30px Arial"; crashCtx.textAlign = "center"; crashCtx.textBaseline = "middle"; crashCtx.fillText("ðŸš€", 0, 0);
                if(crashState === 'FLYING') { crashCtx.rotate(0.5); crashCtx.rotate(Date.now() / 200); crashCtx.strokeStyle = 'rgba(255,255,255,0.5)'; crashCtx.lineWidth = 1; crashCtx.beginPath(); crashCtx.arc(0, 0, 25, 0, Math.PI*2); crashCtx.moveTo(-30, 0); crashCtx.lineTo(-20, 0); crashCtx.moveTo(30, 0); crashCtx.lineTo(20, 0); crashCtx.moveTo(0, -30); crashCtx.lineTo(0, -20); crashCtx.moveTo(0, 30); crashCtx.lineTo(0, 20); crashCtx.stroke(); } crashCtx.restore();
            }
            crashReqId = requestAnimationFrame(loopCrash);
        }
        function handleCrashAction() {
            const btn = document.getElementById('btn-crash-action');
            if (crashState === 'WAITING') { 
                // Toggle Bet/Cancel Logic
                if(crashNextBet) {
                    // CANCEL BET
                    crashNextBet = false;
                    sync(crashBet); // Refund money
                    btn.innerHTML = `<i data-lucide="rocket"></i> PLACE BET`;
                    btn.className = "btn btn-crash";
                    toast("Bet Cancelled", "default");
                } else {
                    // PLACE BET
                    const b = parseFloat(document.getElementById('crash-bet').value); 
                    const a = parseFloat(document.getElementById('crash-auto').value); 
                    if(b > userData.balance || b <= 0) return toast("Low Balance", "error"); 
                    crashBet = b; 
                    crashAuto = a || 0; 
                    crashNextBet = true; 
                    sync(-b); // Deduct money
                    btn.innerHTML = `<i data-lucide="x"></i> CANCEL BET`; 
                    btn.className = "btn btn-outline";
                    btn.style.color = "var(--ruby)";
                    btn.style.borderColor = "var(--ruby)";
                }
            } else if (crashState === 'FLYING' && crashMyBetActive) { 
                cashoutCrash(); 
            }
        }
        function startCountdown() {
            crashState = 'WAITING'; crashMyBetActive = false; const btn = document.getElementById('btn-crash-action');
            
            // If bet was placed for next round, activate it now
            if(crashNextBet) { 
                crashMyBetActive = true; 
                crashNextBet = false; 
                btn.innerHTML = `<i data-lucide="check"></i> BET ACCEPTED`; 
                btn.className = "btn btn-gold"; 
                btn.style.color = "black";
            } else { 
                btn.className = "btn btn-crash"; 
                btn.innerHTML = `<i data-lucide="rocket"></i> PLACE BET`; 
                btn.style.color = "white";
                btn.disabled = false; 
            }
            
            document.getElementById('crash-msg').innerText = "NEXT ROUND IN"; document.getElementById('crash-value').style.color = 'var(--gold)'; document.getElementById('crash-loader').style.display = 'block'; let timeLeft = 5.0;
            const timer = setInterval(() => { if(!window.crashGameRunning) { clearInterval(timer); return; } timeLeft -= 0.1; document.getElementById('crash-value').innerText = Math.abs(timeLeft).toFixed(1) + 's'; document.getElementById('crash-fill').style.width = ((5.0 - timeLeft) / 5.0) * 100 + '%'; if(timeLeft <= 0) { clearInterval(timer); document.getElementById('crash-loader').style.display = 'none'; beginFlight(); } }, 100);
        }
        function beginFlight() {
            const btn = document.getElementById('btn-crash-action');
            if(btn.innerText.includes("PLACE BET") || btn.innerText.includes("CANCEL")) { 
                btn.disabled = true; 
                btn.innerHTML = "WAITING FOR NEXT ROUND"; 
                btn.className = "btn btn-outline";
            } else { 
                btn.innerHTML = `<i data-lucide="download"></i> CASH OUT`; 
                btn.className = "btn btn-gold"; 
                crashMyBetActive = true; 
            } 
            crashState = 'FLYING'; crashMult = 1.00; crashTime = 0; document.getElementById('crash-msg').innerText = "CURRENT FLIGHT"; sfx('engine_start');
        }
        function cashoutCrash() { if(!crashMyBetActive) return; crashMyBetActive = false; const win = crashBet * crashMult; sync(win); sfx('win'); toast(`+${win.toFixed(2)} PKR`, 'success'); const btn = document.getElementById('btn-crash-action'); btn.innerHTML = `<i data-lucide="check"></i> WON ${win.toFixed(0)}`; btn.className = "btn btn-primary"; btn.disabled = true; }
        function doCrash() { crashState = 'CRASHED'; sfx('engine_stop'); sfx('crash_fly'); updateCrashHistory(crashMult); document.getElementById('crash-value').style.color = 'var(--ruby)'; document.getElementById('crash-msg').innerText = "FLEW AWAY"; if(crashMyBetActive) { crashMyBetActive = false; const btn = document.getElementById('btn-crash-action'); btn.className = "btn btn-crash"; btn.innerHTML = "CRASHED"; } setTimeout(() => { if(!window.crashGameRunning) return; crashNextBet = false; startCountdown(); }, 2000); }
        
        // --- MINES & BRICKS LOGIC ---
        let mActive=false, mPos=[], mRev=0, mBet=0;
        function startMines() { const b = parseFloat(document.getElementById('mine-bet').value); const c = parseInt(document.getElementById('mine-count').value); if(b > userData.balance || b <= 0) return toast("Low Balance", "error"); mBet=b; mRev=0; mActive=true; sync(-b); mPos=Array(25).fill(false); let p=0; while(p<c){let r=Math.floor(Math.random()*25); if(!mPos[r]){mPos[r]=true;p++;}} const grid=document.getElementById('mines-grid'); grid.innerHTML=''; for(let i=0; i<25; i++) { const t=document.createElement('div'); t.className='tile'; t.onclick=()=>{ if(!mActive||t.innerText)return; if(mPos[i]){ t.innerText='ðŸ’£'; t.style.background='var(--ruby)'; mActive=false; document.getElementById('btn-m-cash').style.display='none'; sfx('lose'); setTimeout(resetMines,1500); } else { t.innerText='ðŸ’Ž'; t.style.color='var(--emerald)'; mRev++; sfx('gem'); const mult=(25/(25-mRev-c))*0.85; document.getElementById('mine-status').innerText=`${mult.toFixed(2)}x Profit`; } }; grid.appendChild(t); } document.getElementById('btn-m-start').style.display='none'; document.getElementById('btn-m-cash').style.display='flex'; }
        function cashoutMines() { if(!mActive) return; const c=parseInt(document.getElementById('mine-count').value); const mult=(25/(25-mRev-c))*0.85; sync(mBet*mult); confetti(); sfx('win'); resetMines(); }
        function resetMines() { mActive=false; document.getElementById('btn-m-start').style.display='flex'; document.getElementById('btn-m-cash').style.display='none'; document.getElementById('mine-status').innerText=''; }

        let bActive=false, bRow=0, bBombs=[], bBet=0; const bMults = [1.1, 1.3, 1.6, 2.0, 2.8, 4.0, 6.0, 10.0, 20.0, 40.0]; 
        function startBricks() { const b = parseFloat(document.getElementById('brick-bet').value); if(b > userData.balance || b <= 0) return toast("Low Balance", "error"); bBet=b; sync(-b); bActive=true; bRow=0; bBombs = []; for(let i=0; i<10; i++) { if(i < 5) { bBombs.push([Math.floor(Math.random()*3)]); } else { let bombs = []; while(bombs.length < 2) { let r = Math.floor(Math.random()*3); if(!bombs.includes(r)) bombs.push(r); } bBombs.push(bombs); } } document.getElementById('btn-b-start').style.display='none'; renderBricks(); }
        function renderBricks() { const cont=document.getElementById('tower-container'); cont.innerHTML='<div id="ball"></div>'; for(let i=0; i<10; i++) { const r=document.createElement('div'); r.className=`t-row ${i===bRow?'':'locked'}`; for(let j=0; j<3; j++) { const br=document.createElement('div'); br.className='brick'; br.onclick=()=>{ if(bActive && i===bRow) hitBrick(i,j,br); }; r.appendChild(br); } cont.appendChild(r); } document.getElementById('brick-status').innerText=`Row ${bRow+1} Multiplier: ${bMults[bRow]}x`; }
        function hitBrick(rIdx, bIdx, el) { const ball=document.getElementById('ball'); const rect=el.getBoundingClientRect(); const cRect=document.getElementById('tower-container').getBoundingClientRect(); gsap.to(ball, { left: rect.left-cRect.left+(rect.width/2), bottom: cRect.bottom-rect.top-(rect.height/2), duration:0.4, onComplete:()=>{ const currentRowBombs = bBombs[rIdx]; const isBomb = currentRowBombs.includes(bIdx); if(isBomb){ el.innerText='ðŸ’£'; bActive=false; document.getElementById('btn-b-cash').style.display='none'; sfx('lose'); setTimeout(resetBricks,1500); } else { el.innerText='ðŸ’Ž'; bRow++; sfx('gem'); document.getElementById('btn-b-cash').style.display='flex'; if(bRow===10){ sync((bBet*40)+100); confetti(); sfx('win'); toast("JACKPOT +100!", "success"); resetBricks(); } else { gsap.to(ball,{bottom:"-15px", left:"50%", duration:0.3}); renderBricks(); } } }}); }
        function cashoutBricks() { if(!bActive) return; sync(bBet * bMults[bRow-1]); confetti(); sfx('win'); resetBricks(); }
        function resetBricks() { bActive=false; document.getElementById('btn-b-start').style.display='flex'; document.getElementById('btn-b-cash').style.display='none'; gsap.to("#ball",{bottom:"-15px", left:"50%"}); }


        // --- NEON PLINKO LOGIC (CANVAS PHYSICS) ---
        let pCanvas, pCtx, pReqId;
        let pPins = [], pBalls = [], pBuckets = [];
        let pLastDrop = 0; // Cooldown timer
        const pRows = 14; 
        // 5x Max, 0x Included. Symmetrical.
        const pBucketVals = [5, 3, 2, 1, 0, 0.5, 0.2, 0.2, 0.2, 0.5, 0, 1, 2, 3, 5];

        let pWidth, pHeight;

        function initPlinko() {
            pCanvas = document.getElementById('plinko-canvas');
            pCtx = pCanvas.getContext('2d');
            resizePlinko();
            window.addEventListener('resize', resizePlinko);
            setupPlinkoBoard();
            pBalls = [];
            loopPlinko();
        }
        
        function stopPlinko() { cancelAnimationFrame(pReqId); }

        function resizePlinko() {
            const rect = document.getElementById('plinko-container').getBoundingClientRect();
            pCanvas.width = rect.width;
            pCanvas.height = rect.height;
            pWidth = pCanvas.width;
            pHeight = pCanvas.height;
            setupPlinkoBoard();
        }

        function setupPlinkoBoard() {
            pPins = []; pBuckets = [];
            const rows = 14; 
            const gap = pHeight / (rows + 2); 
            
            // PINS
            for (let r = 0; r < rows; r++) {
                const cols = r + 3; 
                for (let c = 0; c < cols; c++) {
                    const x = (pWidth / 2) - ((cols - 1) * gap / 2) + (c * gap);
                    const y = gap + (r * gap);
                    pPins.push({x, y, r: 3});
                }
            }

            // BUCKETS
            const lastRowCols = rows + 2; 
            for(let i=0; i<lastRowCols-1; i++) {
                const x = (pWidth / 2) - ((lastRowCols - 2) * gap / 2) + (i * gap);
                let m = pBucketVals[i] || 1;
                
                let color = '#10b981'; // Default Green (Profit)
                if (m === 0) color = '#ef4444'; // Red (Loss 0x)
                else if (m < 1) color = '#94a3b8'; // Grey (Partial Loss)
                else if (m >= 3) color = '#f59e0b'; // Gold (Big Win)

                pBuckets.push({ x, y: pHeight-15, w: gap-2, h: 20, val: m, color });
            }
        }

        function dropPlinkoBall() {
            const bet = parseFloat(document.getElementById('plinko-bet').value);
            if(bet > userData.balance || bet <= 0) return toast("Low Balance", "error");
            
            const btn = document.getElementById('btn-plinko-drop');
            if(btn.disabled) return;

            sync(-bet);
            
            // Cooldown Logic
            btn.disabled = true;
            let countdown = 2;
            btn.innerHTML = `WAIT ${countdown}s`;
            const timer = setInterval(() => {
                countdown--;
                if(countdown <= 0) {
                    clearInterval(timer);
                    btn.disabled = false;
                    btn.innerHTML = `<i data-lucide="arrow-down-circle"></i> DROP BALL`;
                    lucide.createIcons();
                } else {
                    btn.innerHTML = `WAIT ${countdown}s`;
                }
            }, 1000);
            
            // Spawn Ball
            pBalls.push({
                x: pWidth / 2 + (Math.random() * 4 - 2),
                y: 10,
                vx: (Math.random() - 0.5) * 2, // Slight initial velocity
                vy: 0,
                r: 5,
                bet: bet,
                dead: false
            });
            sfx('click'); 
        }

        function loopPlinko() {
            pCtx.fillStyle = '#0b0f19';
            pCtx.fillRect(0, 0, pWidth, pHeight);

            // Draw Buckets
            pBuckets.forEach(b => {
                pCtx.fillStyle = b.color;
                pCtx.fillRect(b.x - b.w/2, b.y - b.h/2, b.w, b.h);
                pCtx.fillStyle = (b.val === 0 ? '#fff' : '#000');
                if(b.val > 2) pCtx.fillStyle = '#000';
                else if(b.val > 0) pCtx.fillStyle = '#fff';
                
                pCtx.font = "9px Arial";
                pCtx.textAlign = "center";
                pCtx.fillText(b.val + 'x', b.x, b.y + 3);
            });

            // Draw Pins
            pCtx.fillStyle = 'rgba(255,255,255,0.8)';
            pCtx.shadowBlur = 5;
            pCtx.shadowColor = '#fff';
            pPins.forEach(p => {
                pCtx.beginPath();
                pCtx.arc(p.x, p.y, p.r, 0, Math.PI*2);
                pCtx.fill();
            });
            pCtx.shadowBlur = 0;

            // Update Balls
            for (let i = pBalls.length - 1; i >= 0; i--) {
                const b = pBalls[i];
                
                // Physics
                b.vy += 0.25; // Gravity
                b.vx *= 0.99; 
                b.x += b.vx;
                b.y += b.vy;

                // Collision
                for (const p of pPins) {
                    const dx = b.x - p.x;
                    const dy = b.y - p.y;
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    if (dist < b.r + p.r) {
                        const angle = Math.atan2(dy, dx);
                        const speed = Math.sqrt(b.vx*b.vx + b.vy*b.vy) * 0.55; 
                        const noise = (Math.random() - 0.5) * 0.5; 
                        b.vx = Math.cos(angle + noise) * speed;
                        b.vy = Math.sin(angle + noise) * speed;
                        
                        const overlap = (b.r + p.r) - dist;
                        b.x += Math.cos(angle) * overlap;
                        b.y += Math.sin(angle) * overlap;
                    }
                }

                // Check Bottom
                if (b.y > pHeight - 30 && !b.dead) {
                    b.dead = true;
                    for(const bucket of pBuckets) {
                        if(Math.abs(b.x - bucket.x) < bucket.w/2 + 5) {
                            const win = b.bet * bucket.val;
                            if(bucket.val > 0) {
                                sync(win);
                                toast(`+${win.toFixed(0)}`, bucket.val >= 2 ? 'success' : 'default');
                                if(bucket.val >= 3) sfx('win');
                            } else {
                                toast("0x Loss", "error");
                                sfx('lose');
                            }
                            break;
                        }
                    }
                }

                if(b.y > pHeight + 20) {
                    pBalls.splice(i, 1);
                } else {
                    pCtx.fillStyle = '#ff003c';
                    pCtx.shadowBlur = 10;
                    pCtx.shadowColor = '#ff003c';
                    pCtx.beginPath();
                    pCtx.arc(b.x, b.y, b.r, 0, Math.PI*2);
                    pCtx.fill();
                    pCtx.shadowBlur = 0;
                }
            }

            pReqId = requestAnimationFrame(loopPlinko);
        }

        lucide.createIcons();
    </script>
</body>
</html>
